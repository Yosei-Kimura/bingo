<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ“ãƒ³ã‚´ - å‚åŠ è€…ç”¨</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-image {
            width: 100vw;
            height: auto;
            display: block;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 800px;
            width: 100%;
            margin: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .current-number {
            font-size: 4em;
            font-weight: bold;
            color: #e74c3c;
            margin: 30px 0;
            padding: 20px;
            border: 4px solid #e74c3c;
            border-radius: 15px;
            background: #fff5f5;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .called-numbers {
            margin-top: 30px;
        }

        .called-numbers h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .sort-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sort-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 120px;
        }

        .sort-btn.active {
            background: #3498db;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .sort-btn:hover {
            background: #34495e;
        }

        .sort-btn.active:hover {
            background: #2980b9;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .number-item {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header-image {
                width: 100vw;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .current-number {
                font-size: 3em;
            }
            
            .numbers-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <img src="../assets/images/æ¨ªæ–­å¹•.jpg" alt="ã‚„ã»ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¸ãƒ£ã‚ºãƒ“ã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³" class="header-image">
    
    <div class="container">
        <h1>ğŸ¯ ãƒ“ãƒ³ã‚´å¤§ä¼š ğŸ¯</h1>
        
        <div class="current-number" id="currentNumber">
            å¾…æ©Ÿä¸­
        </div>
        
        <button class="refresh-btn" onclick="forceRefresh()">ğŸ”„ æ›´æ–°</button>
        
        <div class="called-numbers">
            <h2>ğŸ“‹ ã“ã‚Œã¾ã§ã«å‡ºãŸç•ªå·</h2>
            
            <div class="sort-controls">
                <button class="sort-btn active" id="sortByOrder" onclick="setSortMode('order')">
                    ğŸ“… å‡ºãŸé †
                </button>
                <button class="sort-btn" id="sortByNumber" onclick="setSortMode('number')">
                    ğŸ”¢ æ•°å­—é †
                </button>
            </div>
            
            <div class="numbers-grid" id="numbersGrid">
                <!-- ç•ªå·ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script>
        let calledNumbers = [];
        let sortMode = 'order';
        let lastUpdateTime = null;
        
        async function loadCalledNumbers() {
            try {
                console.log('APIå‘¼ã³å‡ºã—é–‹å§‹:', '../api/get-data.php');
                
                const response = await fetch('../api/get-data.php?t=' + Date.now(), {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTPã‚¨ãƒ©ãƒ¼:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }
                
                const data = await response.json();
                console.log('ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:', data);
                
                if (!data.success && data.error) {
                    console.error('APIã‚¨ãƒ©ãƒ¼:', data.error);
                    throw new Error(data.error);
                }
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’çµ±ä¸€ï¼ˆnumbersã¾ãŸã¯called_numbersã‚’ä½¿ç”¨ï¼‰
                const newNumbers = data.numbers || data.called_numbers || [];
                
                // ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤ºã‚’æ›´æ–°
                const hasNewData = JSON.stringify(calledNumbers) !== JSON.stringify(newNumbers);
                
                if (hasNewData) {
                    calledNumbers = newNumbers;
                    displayNumbers();
                    console.log('æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º:', {
                        count: calledNumbers.length,
                        timestamp: data.timestamp
                    });
                }
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ‰‹å‹•æ›´æ–°
        function forceRefresh() {
            console.log('æ›´æ–°ã—ã¦ã„ã¾ã™...');
            loadCalledNumbers();
        }

        function setSortMode(mode) {
            sortMode = mode;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('sortByOrder').classList.remove('active');
            document.getElementById('sortByNumber').classList.remove('active');
            document.getElementById(`sortBy${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            displayNumbers();
        }

        function displayNumbers() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜
            try {
                localStorage.setItem('bingoCalledNumbers', JSON.stringify(calledNumbers));
                localStorage.setItem('bingoLastUpdate', Date.now().toString());
            } catch (error) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            const currentNumberEl = document.getElementById('currentNumber');
            const numbersGridEl = document.getElementById('numbersGrid');
            
            // æœ€æ–°ã®ç•ªå·ã‚’è¡¨ç¤º
            if (calledNumbers.length > 0) {
                const latestNumber = calledNumbers[calledNumbers.length - 1];
                currentNumberEl.textContent = latestNumber;
            } else {
                currentNumberEl.textContent = 'å¾…æ©Ÿä¸­';
            }
            
            // å…¨ã¦ã®ç•ªå·ã‚’è¡¨ç¤º
            numbersGridEl.innerHTML = '';
            
            let sortedNumbers;
            if (sortMode === 'order') {
                // å‡ºãŸé †ï¼ˆæ–°ã—ã„é †ï¼‰
                sortedNumbers = [...calledNumbers].reverse();
            } else {
                // æ•°å­—é †ï¼ˆå°ã•ã„é †ï¼‰
                sortedNumbers = [...calledNumbers].sort((a, b) => a - b);
            }
            
            sortedNumbers.forEach((number, index) => {
                const numberDiv = document.createElement('div');
                numberDiv.className = 'number-item';
                numberDiv.textContent = number;
                
                // æœ€æ–°ã®ç•ªå·ã¯ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå‡ºãŸé †ã®å ´åˆã®ã¿ï¼‰
                if (sortMode === 'order' && index === 0 && calledNumbers.length > 0) {
                    numberDiv.style.background = '#e74c3c';
                    numberDiv.style.transform = 'scale(1.1)';
                    numberDiv.style.boxShadow = '0 4px 8px rgba(231, 76, 60, 0.4)';
                } else if (sortMode === 'number' && number === calledNumbers[calledNumbers.length - 1]) {
                    // æ•°å­—é †ã®å ´åˆã€æœ€æ–°ã®ç•ªå·ã«è–„ã„æ ç·šã‚’è¿½åŠ 
                    numberDiv.style.border = '3px solid #e74c3c';
                    numberDiv.style.boxShadow = '0 2px 4px rgba(231, 76, 60, 0.3)';
                }
                
                numbersGridEl.appendChild(numberDiv);
            });
            
            console.log('è¡¨ç¤ºæ›´æ–°å®Œäº†:', {
                count: calledNumbers.length,
                latest: calledNumbers[calledNumbers.length - 1],
                sortMode: sortMode
            });
        }

        // åˆæœŸåŒ–
        function initialize() {
            console.log('åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™...');
            loadCalledNumbers();
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        initialize();

        // ãƒšãƒ¼ã‚¸ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸã¨ãã‚‚æ›´æ–°
        window.addEventListener('focus', () => {
            console.log('ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®æ›´æ–°...');
            forceRefresh();
        });
    </script>
</body>
</html>

