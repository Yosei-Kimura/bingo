<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éì„É≥„Ç¥ - ÂèÇÂä†ËÄÖÁî®</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-image {
            width: 100vw;
            height: auto;
            display: block;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 800px;
            width: 100%;
            margin: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .current-number {
            font-size: 4em;
            font-weight: bold;
            color: #e74c3c;
            margin: 30px 0;
            padding: 20px;
            border: 4px solid #e74c3c;
            border-radius: 15px;
            background: #fff5f5;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .called-numbers {
            margin-top: 30px;
        }

        .called-numbers h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .sort-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sort-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 120px;
        }

        .sort-btn.active {
            background: #3498db;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .sort-btn:hover {
            background: #34495e;
        }

        .sort-btn.active:hover {
            background: #2980b9;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .number-item {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header-image {
                width: 100vw;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .current-number {
                font-size: 3em;
            }
            
            .numbers-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <img src="../assets/images/Ê®™Êñ≠Âπï.jpg" alt="„ÇÑ„Åª„Éï„Ç°„Éü„É™„Éº„Ç∏„É£„Ç∫„Éì„Ç¢„Ç¨„Éº„Éá„É≥" class="header-image">
    
    <div class="container">
        <h1>üéØ „Éì„É≥„Ç¥Â§ß‰ºö üéØ</h1>
        
        <div class="current-number" id="currentNumber">
            ÂæÖÊ©ü‰∏≠
        </div>
        
        <button class="refresh-btn" onclick="forceRefresh()">üîÑ Êõ¥Êñ∞</button>
        
        <div class="called-numbers">
            <h2>üìã „Åì„Çå„Åæ„Åß„Å´Âá∫„ÅüÁï™Âè∑</h2>
            
            <div class="sort-controls">
                <button class="sort-btn active" id="sortByOrder" onclick="setSortMode('order')">
                    üìÖ Âá∫„ÅüÈ†Ü
                </button>
                <button class="sort-btn" id="sortByNumber" onclick="setSortMode('number')">
                    üî¢ Êï∞Â≠óÈ†Ü
                </button>
            </div>
            
            <div class="numbers-grid" id="numbersGrid">
                <!-- Áï™Âè∑„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
            </div>
        </div>
    </div>

    <script>
        let calledNumbers = [];
        let sortMode = 'order';
        let lastUpdateTime = null;
        
        async function loadCalledNumbers() {
            try {
                console.log('APIÂëº„Å≥Âá∫„ÅóÈñãÂßã:', '../api/get-data.php');
                
                const response = await fetch('../api/get-data.php?t=' + Date.now(), {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('„É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP„Ç®„É©„Éº:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }
                
                const data = await response.json();
                console.log('„Éë„Éº„Çπ„Åï„Çå„Åü„Éá„Éº„Çø:', data);
                
                if (!data.success && data.error) {
                    console.error('API„Ç®„É©„Éº:', data.error);
                    throw new Error(data.error);
                }
                
                // „É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„ÇíÁµ±‰∏ÄÔºànumbers„Åæ„Åü„ÅØcalled_numbers„Çí‰ΩøÁî®Ôºâ
                const newNumbers = data.numbers || data.called_numbers || [];
                
                // „Éá„Éº„Çø„ÅåÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫„ÇíÊõ¥Êñ∞
                const hasNewData = JSON.stringify(calledNumbers) !== JSON.stringify(newNumbers);
                
                if (hasNewData) {
                    calledNumbers = newNumbers;
                    displayNumbers();
                    console.log('Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÇíÊ§úÂá∫:', {
                        count: calledNumbers.length,
                        timestamp: data.timestamp
                    });
                }
                
            } catch (error) {
                console.error('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        // ÊâãÂãïÊõ¥Êñ∞
        function forceRefresh() {
            console.log('Êõ¥Êñ∞„Åó„Å¶„ÅÑ„Åæ„Åô...');
            loadCalledNumbers();
        }

        function setSortMode(mode) {
            sortMode = mode;
            
            // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.getElementById('sortByOrder').classList.remove('active');
            document.getElementById('sortByNumber').classList.remove('active');
            document.getElementById(`sortBy${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            
            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            displayNumbers();
        }

        function displayNumbers() {
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´„ÇÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰øùÂ≠ò
            try {
                localStorage.setItem('bingoCalledNumbers', JSON.stringify(calledNumbers));
                localStorage.setItem('bingoLastUpdate', Date.now().toString());
            } catch (error) {
                console.error('„É≠„Éº„Ç´„É´‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
            
            const currentNumberEl = document.getElementById('currentNumber');
            const numbersGridEl = document.getElementById('numbersGrid');
            
            // ÊúÄÊñ∞„ÅÆÁï™Âè∑„ÇíË°®Á§∫
            if (calledNumbers.length > 0) {
                const latestNumber = calledNumbers[calledNumbers.length - 1];
                currentNumberEl.textContent = latestNumber;
            } else {
                currentNumberEl.textContent = 'ÂæÖÊ©ü‰∏≠';
            }
            
            // ÂÖ®„Å¶„ÅÆÁï™Âè∑„ÇíË°®Á§∫
            numbersGridEl.innerHTML = '';
            
            let sortedNumbers;
            if (sortMode === 'order') {
                // Âá∫„ÅüÈ†ÜÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
                sortedNumbers = [...calledNumbers].reverse();
            } else {
                // Êï∞Â≠óÈ†ÜÔºàÂ∞è„Åï„ÅÑÈ†ÜÔºâ
                sortedNumbers = [...calledNumbers].sort((a, b) => a - b);
            }
            
            sortedNumbers.forEach((number, index) => {
                const numberDiv = document.createElement('div');
                numberDiv.className = 'number-item';
                numberDiv.textContent = number;
                
                // ÊúÄÊñ∞„ÅÆÁï™Âè∑„ÅØÁâπÂà•„Å™„Çπ„Çø„Ç§„É´ÔºàÂá∫„ÅüÈ†Ü„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
                if (sortMode === 'order' && index === 0 && calledNumbers.length > 0) {
                    numberDiv.style.background = '#e74c3c';
                    numberDiv.style.transform = 'scale(1.1)';
                    numberDiv.style.boxShadow = '0 4px 8px rgba(231, 76, 60, 0.4)';
                } else if (sortMode === 'number' && number === calledNumbers[calledNumbers.length - 1]) {
                    // Êï∞Â≠óÈ†Ü„ÅÆÂ†¥Âêà„ÄÅÊúÄÊñ∞„ÅÆÁï™Âè∑„Å´ËñÑ„ÅÑÊû†Á∑ö„ÇíËøΩÂä†
                    numberDiv.style.border = '3px solid #e74c3c';
                    numberDiv.style.boxShadow = '0 2px 4px rgba(231, 76, 60, 0.3)';
                }
                
                numbersGridEl.appendChild(numberDiv);
            });
            
            console.log('Ë°®Á§∫Êõ¥Êñ∞ÂÆå‰∫Ü:', {
                count: calledNumbers.length,
                latest: calledNumbers[calledNumbers.length - 1],
                sortMode: sortMode
            });
        }

        // ÂàùÊúüÂåñ
        function initialize() {
            console.log('ÂàùÊúüÂåñ„ÇíÈñãÂßã„Åó„Åæ„Åô...');
            loadCalledNumbers();
        }

        // ÂàùÊúüË™≠„ÅøËæº„Åø
        initialize();

        // „Éö„Éº„Ç∏„Åå„Éï„Ç©„Éº„Ç´„Çπ„Åï„Çå„Åü„Å®„Åç„ÇÇÊõ¥Êñ∞
        window.addEventListener('focus', () => {
            console.log('„Éö„Éº„Ç∏„Éï„Ç©„Éº„Ç´„ÇπÊôÇ„ÅÆÊõ¥Êñ∞...');
            forceRefresh();
        });
    </script>
</body>
</html>

